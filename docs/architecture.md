# Architecture overview

## Components

The Pipelet OCPP SDK bundles the following services:

- **Frontend (Vite/React)** — renders the workflow canvas, simulator dashboard, log console and administration panels.
- **Flask API** — exposes REST endpoints for pipelet/workflow CRUD, simulator controls, log streaming and import/export.
- **OCPP Central System** — maintains the OCPP 1.6 WebSocket endpoint that receives charge point messages.
- **Charge Point Simulator** — a headless worker that emits OCPP payloads used for integration testing and demos.
- **Pipelet Runtime** — executes workflows in response to inbound OCPP events by invoking Python pipelets in sequence.
- **MySQL** — persists pipelet definitions, workflow graphs, authentication tokens and execution logs.

The containers are wired through Docker Compose and share environment variables provided via `.env`.

## Runtime flow

The simulator (or a physical charge point) connects to the central system and triggers a sequence of OCPP calls. The diagram
below highlights the most relevant interactions:

PlantUML source: [diagrams/ocpp-sequence.puml](diagrams/ocpp-sequence.puml)

1. A charge point issues `BootNotification` and `Heartbeat` messages to register itself.
2. Operators request `Authorize` to validate an RFID token and then `StartTransaction` / `StopTransaction` to control charging.
3. Each transaction event is pushed into the Flask API via internal hooks where the workflow runner evaluates matching pipelets.

Workflows themselves are executed in the runtime loop sketched in the following sequence diagram:

PlantUML source: [diagrams/workflow-runtime.puml](diagrams/workflow-runtime.puml)

1. An inbound event triggers the runner with metadata (payload, timestamps, token).
2. `run_pipelet` iterates over the graph nodes, resolves built-in definitions and executes pipelet code.
3. Results are written to the log store and forwarded to subscribed SSE clients.

## Import / export format

The platform supports capturing a full snapshot (pipelets and workflows) in JSON:

```json
{
  "version": 1,
  "pipelets": [
    {"name": "Debug Template", "event": "StartTransaction", "code": "..."}
  ],
  "workflows": [
    {"name": "StartTransaction Flow", "event": "StartTransaction", "graph_json": "..."}
  ]
}
```

- `version` allows backwards compatible migrations for future schema evolutions.
- `pipelets` contains Python snippets that are synchronised to the database.
- `workflows` stores the Rete.js graph serialisation generated by the frontend.

Export snapshots can be captured with `make export` and restored by `make import`. The example `seed.py` script mirrors the same
structure to provision built-in definitions.
